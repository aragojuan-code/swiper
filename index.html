<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>Swiper – Historia de 4 mundos</title>
<meta name="theme-color" content="#0b0f14"/>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0b0f14; --panel:#101722; --ink:#e6eef7; --muted:#9fb3c9;
    --shadow:rgba(0,0,0,.45);
    --radius:22px;

    /* Tamaño de tarjeta (NO pantalla completa) */
    --card-w: min(92vw, 520px);
    --ratio: 1.28;                    /* alto = ancho * ratio (aprox 9:11.5) */
    --card-h: calc(var(--card-w) * var(--ratio));

    /* Altura reservada para las decisiones dentro de la card */
    --choices-h: 96px;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  body{overflow:hidden;-webkit-user-select:none;user-select:none;touch-action:pan-y}

  /* Fondo video + velo general */
  .bg{position:fixed;inset:0;z-index:0;overflow:hidden;pointer-events:none}
  .bg video{position:absolute;width:100%;height:100%;object-fit:cover;filter:brightness(.9) saturate(.95) contrast(1)}
  .bg::after{content:"";position:absolute;inset:0;background:radial-gradient(ellipse at 50% 110%, rgba(0,0,0,.55), rgba(0,0,0,.15) 50%, rgba(0,0,0,.05) 70%)}
  .veil{position:fixed;inset:0;background:linear-gradient(to bottom, rgba(5,8,12,.40), rgba(5,8,12,.25));z-index:0}

  /* Encabezado */
  header{
    position:fixed;left:0;right:0;top:0;z-index:2;
    display:flex;justify-content:space-between;align-items:center;
    padding:calc(8px + env(safe-area-inset-top,0px)) 12px 8px;
  }
  .topbar{display:flex;gap:8px;font-size:12px;color:#c9d5e7;background:rgba(0,0,0,.35);padding:6px 10px;border-radius:12px}
  .kb{min-width:24px}

  /* Área central: centra la tarjeta y deja aire al fondo */
  .board{
    position:relative; z-index:1;
    min-height:100vh;
    padding:calc(58px + env(safe-area-inset-top,0px)) 12px calc(24px + env(safe-area-inset-bottom,0px));
    display:grid; place-items:center;
  }

  /* TARJETA flotante */
  .card{
    position:relative;
    width:var(--card-w);
    height:var(--card-h);
    border-radius:var(--radius);
    overflow:hidden;
    box-shadow:0 18px 50px rgba(0,0,0,.45), 0 1px 0 rgba(255,255,255,.04) inset;
    background:#0e1520;
    will-change:transform,opacity;
    touch-action:none; /* capturamos el swipe horizontal */
  }
  .card img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .fade{position:absolute;inset:0;background:linear-gradient(to bottom, transparent 52%, rgba(0,0,0,.25) 68%, rgba(0,0,0,.55) 86%)}

  /* Texto dentro de la TARJETA (no en viewport) */
  .text{
    position:absolute; left:0; right:0;
    bottom:calc(var(--choices-h) + 14px);
    padding:14px 16px; font-size:15px; line-height:1.45; color:#e9f1fb;
    background:linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0));
  }

  /* Pista */
  .hint{
    position:absolute; top:10px; left:10px;
    font-size:11px; color:#c9d5e7; background:rgba(0,0,0,.35);
    padding:6px 8px; border-radius:10px
  }

  /* Decisiones SOLO texto dentro de la card */
  .choices{
    position:absolute; left:12px; right:12px;
    bottom:12px; min-height:var(--choices-h);
    display:flex; gap:12px; align-items:stretch; justify-content:space-between;
    pointer-events:none;
  }
  .choice{
    flex:1; display:flex; align-items:center; gap:8px; min-width:0;
    padding:12px 14px; border:1px solid rgba(255,255,255,.08); border-radius:14px;
    background:rgba(255,255,255,.06); backdrop-filter:blur(4px);
  }
  .choice .opt{font-weight:700; font-size:15px; line-height:1.25; white-space:normal}
  .choice .arr{opacity:.9; font-size:16px; flex:0 0 auto}
  .choice-left{ justify-content:flex-start; text-align:left }
  .choice-left .arr{ order:-1; margin-right:8px }
  .choice-right{ justify-content:flex-end; text-align:right }
  .choice-right .arr{ order:1; margin-left:8px }

  @media (max-width:360px){
    .choices{ flex-direction:column; gap:8px }
    :root{ --choices-h:120px }
  }

  .toast{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom:calc(18px + env(safe-area-inset-bottom,0px));z-index:4;
    background:#0e1520;border:1px solid rgba(255,255,255,.08);color:#dfe8f5;
    padding:10px 12px;border-radius:12px;font-size:13px;opacity:0;pointer-events:none;box-shadow:0 10px 30px var(--shadow)
  }
  .toast.show{opacity:1;transition:opacity .25s}
  :root{
  /* duraciones de animación */
  --swipe-dur: 800ms;
  --restart-fade: 1100ms;
    --linger-ms: 1300ms;   /* tiempo para leer antes de hacer fade-out */
}

/* transición general de las cartas */
.card{
  transition:
    transform var(--swipe-dur) cubic-bezier(.22,.61,.36,1),
    opacity   var(--swipe-dur) ease,
    filter    var(--swipe-dur) ease;
}

/* salida al hacer swipe */
.card.swipe-exit-left  { transform: translate3d(-120px,0,0) rotate(-4deg); opacity:0; filter: blur(6px); }
.card.swipe-exit-right { transform: translate3d(120px,0,0)  rotate( 4deg); opacity:0; filter: blur(6px); }

/* entrada de cada carta */
.card.enter   { opacity:0; transform: scale(.985); filter: blur(6px); }
.card.enter.show { opacity:1; transform: scale(1); filter: blur(0); }

/* pantalla negra para reinicios/teletransportes */
.fade-screen{
  position:fixed; inset:0; background:rgba(0,0,0,0); z-index:6; pointer-events:none;
  transition: background var(--restart-fade) ease;
}
.fade-screen.on { background:rgba(0,0,0,.85); }
/* mientras se arrastra: sin transiciones */
.card.dragging{
  transition:none !important;
  filter:none !important;
}

</style>
</head>
<body>
  <div class="bg"><video id="bgvid" playsinline muted loop autoplay></video></div>
  <div class="veil"></div>

  <div class="wrap">
    <header>
      <div class="topbar"><span class="pill" id="worldTag">—</span><span class="crumbs" id="crumbs">—</span></div>
      <div class="kb"></div>
    </header>
    <div class="board" id="board"></div>
    <div class="toast" id="toast"></div>
  </div>

<script>
/* ========= CONFIG ========= */
const PROJECT_REF = "rdoivmucgucouauyqdos";
const DATA_BASE   = `https://${PROJECT_REF}.supabase.co/storage/v1/object/public/data`;
const IMG_BASE    = `https://${PROJECT_REF}.supabase.co/storage/v1/object/public/swiper`;
const WORLD_BASE  = `https://${PROJECT_REF}.supabase.co/storage/v1/object/public/worlds`;
const URL_CARDS   = `${DATA_BASE}/cards.json`;
const URL_IMAGES  = `${DATA_BASE}/images.json`;
const URL_WORLDS  = `${DATA_BASE}/worlds.json`;

/* ========= UTILS ========= */
const slug = s => String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
const byId = (arr, key="id") => Object.fromEntries(arr.map(o => [o[key], o]));

/* ========= STATE ========= */
const state = { cards:[], map:{}, images:[], worlds:{}, world:"", order:[], index:0 };

/* ========= LOAD ========= */
async function loadJSON(url){
  const r = await fetch(url);
  if(!r.ok){ throw new Error(`No pude cargar ${url} (HTTP ${r.status})`); }
  const ct = r.headers.get("content-type")||"";
  return ct.includes("application/json") ? r.json() : JSON.parse(await r.text());
}
async function boot(){
  const [cards, imgs, wlds] = await Promise.all([
    loadJSON(URL_CARDS), loadJSON(URL_IMAGES).catch(()=>[]), loadJSON(URL_WORLDS).catch(()=>({}))
  ]);
  const src = Array.isArray(cards) ? cards : (cards.data||[]);
  state.cards = src.map(normalizeCard);
  state.map   = byId(state.cards);
  state.images = Array.isArray(imgs) ? imgs : (imgs.data||[]);
  state.worlds = wlds || {};

  state.world = state.cards[0]?.mundo || "El Bosque de los Susurros";
  rebuildOrderForWorld(state.world);
  setWorldBackground(state.world);
  goToId(state.order[0]);
}

function normalizeCard(o){
  const pick = (obj, keys) => keys.find(k=>k in obj) && obj[keys.find(k=>k in obj)];
  return {
    mundo:   pick(o,["Mundo","mundo"]) || "",
    id:      String(pick(o,["ID / Nombre","id","ID","Nombre"])||""),
    tipo:   (pick(o,["Tipo","tipo"]) || "decision").toLowerCase(),
    texto:   pick(o,["Texto (breve)","texto"]) || "",
    optL:    pick(o,["Opción ← (izquierda)","optL","opcion_izquierda"]) || "",
    resL:    pick(o,["Resultado ←","resL","resultado_izquierda"]) || "",
    optR:    pick(o,["Opción → (derecha)","optR","opcion_derecha"]) || "",
    resR:    pick(o,["Resultado →","resR","resultado_derecha"]) || "",
    image_file: o.image_file || o.imageFilename || null,
  };
}

function rebuildOrderForWorld(worldName){
  const list = state.cards.filter(c => c.mundo === worldName);
  list.sort((a,b)=> a.id.localeCompare(b.id,'es',{numeric:true,sensitivity:'base'}));
  state.order = list.map(c => c.id);
  state.index = 0;
}

/* ========= BG VIDEO ========= */
function setWorldBackground(worldName){
  const vid = document.getElementById("bgvid");
  const url = state.worlds[worldName] || guessWorldUrl(worldName);
  if(!url) return;
  if (vid.src !== url){ vid.src = url; vid.play?.().catch(()=>{}); }
}
document.addEventListener("touchend", ()=>{ document.getElementById("bgvid")?.play?.().catch(()=>{}); }, {once:true});
function guessWorldUrl(worldName){
  const k = slug(worldName).toLowerCase();
  if (k.includes("bosque"))   return `${WORLD_BASE}/bosque_bg.mp4`;
  if (k.includes("castillo")) return `${WORLD_BASE}/castillo_bg.mp4`;
  if (k.includes("monstruo")) return `${WORLD_BASE}/monstruo_bg.mp4`;
  if (k.includes("princesa")) return `${WORLD_BASE}/princesa_bg.mp4`;
  return "";
}

/* ========= RENDER ========= */
function imageUrlFor(card){
  if (card.image_file) return `${IMG_BASE}/${card.image_file}`;
  const idKey = slug(card.id).toLowerCase().replace(/[^\w]+/g,"");
  if (state.images.length){
    const hit = state.images.find(x=>{
      const fname = (x.filename||x.file||"").toLowerCase().replace(/[^\w]+/g,"");
      return fname.includes(idKey);
    });
    if (hit?.filename)  return `${IMG_BASE}/${hit.filename}`;
    if (hit?.image_url) return hit.image_url;
    if (hit?.url)       return hit.url;
  }
  const fname = `${slug(card.mundo).toLowerCase().replace(/[^\w]+/g,"_")}_${slug(card.id).toLowerCase().replace(/[^\w]+/g,"_")}.png`;
  return `${IMG_BASE}/${fname}`;
}

function renderCard(card){
  const board = document.getElementById("board");
  board.innerHTML = "";

  const wrap = el("div","card");
  const img  = el("img"); img.src = imageUrlFor(card); img.alt = "";
  const fade = el("div","fade");
  const text = el("div","text"); text.textContent = card.texto || "";

  const hint = el("div","hint"); hint.textContent = "Desliza ← / →";

  const choices = el("div","choices");
  const chL = el("div","choice choice-left");
  chL.innerHTML = `<span class="arr">←</span><span class="opt">${card.optL || labelFromResult(card.resL,"Izquierda")}</span>`;
  const chR = el("div","choice choice-right");
  chR.innerHTML = `<span class="opt">${card.optR || labelFromResult(card.resR,"Derecha")}</span><span class="arr">→</span>`;
  choices.append(chL,chR);

  wrap.append(img, fade, text, choices, hint);
  board.append(wrap);
// entrada suave
wrap.classList.add('enter');
requestAnimationFrame(()=> wrap.classList.add('show'));

  enableSwipe(wrap, dir=>{
    if(dir==="left")  applyResult(card.resL||"", "left");
    if(dir==="right") applyResult(card.resR||"", "right");
  });

  document.getElementById("worldTag").textContent = state.world;

  if (card.tipo === "transition"){
    setTimeout(()=>{
      const next = pickAutoResult(card);
      applyResult(next.cmd, next.dir);
    }, 700);
  }
}
function screenFade(cb){
  const dur = getCssMs('--restart-fade', 900);
  const veil = document.createElement('div');
  veil.className = 'fade-screen';
  document.body.appendChild(veil);
  // funde a negro
  requestAnimationFrame(()=> veil.classList.add('on'));
  setTimeout(()=>{
    try{ cb?.(); }catch(e){}
    // fade in
    veil.classList.remove('on');
    setTimeout(()=> veil.remove(), dur);
  }, dur);
}

function labelFromResult(res, fallback){
  const p = parseResult(res);
  if (p.type==="finish")  return "Final";
  if (p.type==="restart") return "Reiniciar";
  if (p.type==="pass")    return "Cambiar de mundo";
  if (p.type==="goto")    return "Avanzar";
  return fallback;
}

function pickAutoResult(card){
  const cands = [card.resL, card.resR].filter(Boolean);
  for(const r of cands){
    const p = parseResult(r);
    if(["restart","pass","goto","finish"].includes(p.type)) return {cmd:r, dir:"right"};
  }
  return {cmd:"REINICIA → 1", dir:"right"};
}

/* ========= NAV + PARSER ========= */
function goToId(id){
  const card = state.map[id];
  if(!card){ toast(`No encuentro la carta "${id}"`); return; }
  if (card.mundo !== state.world){
    state.world = card.mundo; rebuildOrderForWorld(state.world); setWorldBackground(state.world);
  }
  state.index = state.order.indexOf(card.id);
  if (state.index < 0){ state.order.push(card.id); state.index = state.order.length-1; }
  renderCard(card);
}

function restartWorld(){
  rebuildOrderForWorld(state.world);
  setWorldBackground(state.world);
  goToId(state.order[0]);
}

/* ======== PARSER ======== */
function parseResult(s){
  const clean = slug(s||"");

  if (/fin\s*del\s*juego/i.test(clean)) return {type:"finish"};
  if (/reinicia/i.test(clean)) return {type:"restart"};

  let m = clean.match(/pass.*?→\s*([A-Za-z0-9_]+)/i);
  if (m) return {type:"pass", to: m[1]};

  m = clean.match(/loop\s*(?:→|a)\s*([A-Za-z0-9_]+)/i);
  if (m) return {type:"goto", id: normalizeShortId(m[1])};

  m = clean.match(/→\s*([A-Za-z0-9_]+)/);
  if (m) return {type:"goto", id: normalizeShortId(m[1])};

  return {type:"noop"};
}

function normalizeShortId(token){
  const t = String(token||"").toLowerCase();
  if (t.startsWith("carta_")) return token;
  const keys = Object.keys(state.map);
  const hit = keys.find(k=>{
    const kk = k.toLowerCase();
    return kk.endsWith(`_${t}`) || kk.includes(`_${t}_`) || kk===t;
  });
  return hit || token;
}

function canonicalWorldName(token){
  const k = slug(token).toLowerCase();
  if (k.includes("castillo")) return "El Castillo de los Espejos";
  if (k.includes("monstruo")) return "El Monstruo Final";
  if (k.includes("princesa")) return "La Princesa Durmiente";
  if (k.includes("bosque") || k.includes("mundo_1") || k==="1") return "El Bosque de los Susurros";
  const worlds = [...new Set(state.cards.map(c=>c.mundo))];
  return worlds.find(w => slug(w).toLowerCase().includes(k)) || state.world;
}

function applyResult(res){
  const p = parseResult(res);
  const linger = getCssMs('--linger-ms', 1100);
  const firstId = state.order[0];

  switch(p.type){
    case "finish":
      toast("FIN DEL JUEGO ✨", 900);
      // deja leer y luego fade + reinicio
      setTimeout(()=> screenFade(()=>{ state.world="El Bosque de los Susurros"; restartWorld(); }), linger);
      break;

    case "pass":
      // cambio de mundo: también dejamos leer y luego fade
      setTimeout(()=> screenFade(()=>{
        state.world = canonicalWorldName(p.to);
        rebuildOrderForWorld(state.world);
        setWorldBackground(state.world);
        goToId(state.order[0]);
      }), linger);
      break;

    case "restart":
      // reinicio explícito: deja leer y luego fade
      setTimeout(()=> screenFade(()=> restartWorld()), linger);
      break;

    case "goto":
      // si vamos a la PRIMERA carta, aplica el mismo patrón
      if (p.id === firstId){
        setTimeout(()=> screenFade(()=> goToId(p.id)), linger);
      } else {
        goToId(p.id);
      }
      break;

    default:
      toast("…", 500);
  }
}


/* ========= SWIPE ========= */
function enableSwipe(el, cb){
  let startX=0, startY=0, dx=0, dy=0, active=false;
  const dur = getCssMs('--swipe-dur', 620);
  const TH = 60;

  const onDown = (e)=>{
    active = true;
    const p = point(e);
    startX = p.x; startY = p.y; dx = dy = 0;
    el.classList.add('dragging');               // <- sin transiciones
    el.setPointerCapture?.(e.pointerId);
  };

  const onMove = (e)=>{
    if(!active) return;
    const p = point(e);
    dx = p.x - startX; dy = p.y - startY;
    // aplicar transform inmediato, sin easing
    el.style.transform = `translate3d(${dx}px, ${dy*0.12}px, 0) rotate(${dx*0.05}deg)`;
    el.style.opacity = String(Math.max(.45, 1 - Math.abs(dx)/420));
  };

  const onUp = ()=>{
    if(!active) return;
    active = false;
    el.classList.remove('dragging');
    const dir = dx < -TH ? 'left' : dx > TH ? 'right' : null;

    if (dir){
      // salida con clase animada
      el.classList.add(dir==='left' ? 'swipe-exit-left' : 'swipe-exit-right');
      setTimeout(()=> cb(dir), dur);
    } else {
      // volver rápido
      el.style.transition = "transform .18s ease, opacity .18s ease";
      el.style.transform = "translate3d(0,0,0) rotate(0)";
      el.style.opacity = "1";
      setTimeout(()=> el.style.transition = "", 200);
    }
  };

  el.addEventListener("pointerdown", onDown);
  window.addEventListener("pointermove", onMove, {passive:true});
  window.addEventListener("pointerup", onUp);
  window.addEventListener("pointercancel", onUp);
}


// lee variables CSS en ms
function getCssMs(name, fallback){
  const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  if (!v) return fallback;
  if (v.endsWith('ms')) return parseFloat(v);
  if (v.endsWith('s'))  return parseFloat(v)*1000;
  return fallback;
}

function point(e){ return {x: e.clientX ?? (e.touches?.[0]?.clientX||0), y: e.clientY ?? (e.touches?.[0]?.clientY||0)}; }

/* ========= MISC ========= */
function el(tag,cls){ const n=document.createElement(tag); if(cls) n.className=cls; return n; }
function toast(msg,ms=1400){ const t=document.getElementById("toast"); t.textContent=msg; t.classList.add("show"); clearTimeout(t._h); t._h=setTimeout(()=>t.classList.remove("show"),ms); }
window.addEventListener("keydown",(e)=>{
  const cur=state.map[state.order[state.index]]; if(!cur) return;
  if(e.key==="ArrowLeft")  applyResult(cur.resL||"","left");
  if(e.key==="ArrowRight") applyResult(cur.resR||"","right");
  if(e.key.toLowerCase()==="r") restartWorld();
});

/* ========= START ========= */
boot().catch(err=>{ console.error(err); toast("Error cargando datos"); });
</script>
</body>
</html>
